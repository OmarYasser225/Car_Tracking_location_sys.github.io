<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Location Tracker Web</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    #status {
      background: #fff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      max-width: 600px;
      margin: auto;
    }
    .log {
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>üìç Location Tracker Web</h1>
  <div id="status">
    <p><strong>Status:</strong> <span id="status-text">Initializing...</span></p>
    <div class="log" id="log"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://wngqbymqpbrcpgtuqetr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZ3FieW1xcGJyY3BndHVxZXRyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNDIwMDM3MiwiZXhwIjoyMDQ5Nzc2MzcyfQ.9hTOd76a0rjjiZOZy8Hb6GKP0JXWCz6qyx4lQtoFgFU";
    const TABLE_NAME = "Location";

    const headers = {
      "apikey": SUPABASE_KEY,
      "Authorization": `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      "Prefer": "return=representation"
    };

    const logEl = document.getElementById('log');
    const statusText = document.getElementById('status-text');

    function log(msg) {
      console.log(msg);
      logEl.textContent += `\n${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function checkGetStatus() {
      try {
        const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=GET&GET=eq.1`;
        const response = await fetch(url, { headers });
        const data = await response.json();
        return data.length > 0;
      } catch (e) {
        log(`Error checking GET status: ${e}`);
        return false;
      }
    }

    function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject("Geolocation not supported");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve({
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            });
          },
          (err) => reject("Failed to get location: " + err.message),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    }

    async function saveToSupabase(locationData) {
      try {
        // Get record with GET=1
        const getUrl = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*&GET=eq.1`;
        const getResp = await fetch(getUrl, { headers });
        const records = await getResp.json();

        if (!records.length) {
          log("‚ùå No records with GET=1 found");
          return false;
        }

        const updateUrl = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?GET=eq.1`;
        const payload = {
          Latitude: locationData.latitude,
          Longitude: locationData.longitude,
          GET: 0
        };

        const updateResp = await fetch(updateUrl, {
          method: "PATCH",
          headers,
          body: JSON.stringify(payload)
        });

        if (updateResp.ok) {
          log("‚úÖ Successfully updated location to Supabase");
          return true;
        } else {
          const errText = await updateResp.text();
          log(`‚ùå Update failed: ${errText}`);
          return false;
        }
      } catch (e) {
        log(`‚ùå Network error: ${e}`);
        return false;
      }
    }

    async function mainLoop() {
      while (true) {
        try {
          statusText.textContent = "Checking for GET=1...";
          const shouldGet = await checkGetStatus();

          if (shouldGet) {
            statusText.textContent = "GET=1 detected, fetching location...";
            const location = await getCurrentLocation();
            log(`üìç Location: ${JSON.stringify(location)}`);

            const success = await saveToSupabase(location);
            if (success) {
              statusText.textContent = "‚úÖ Location updated successfully";
            } else {
              statusText.textContent = "‚ö†Ô∏è Failed to update location";
            }
          }

        } catch (e) {
          log(`üí• Unexpected error: ${e}`);
          statusText.textContent = "Error occurred, retrying...";
        }

        await new Promise(r => setTimeout(r, 3000)); // wait 3 seconds
      }
    }

    log("üåê Starting Location Tracker Web App...");
    mainLoop();
  </script>
</body>
</html>
